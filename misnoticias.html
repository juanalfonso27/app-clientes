<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mis Noticias</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f5f5f5; padding: 20px; }
        .container { max-width: 800px; margin: 0 auto; }
        h1 { text-align: center; margin-bottom: 20px; color: #333; }
        .form-section { background: #fff; padding: 20px; border-radius: 12px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: 600; color: #555; }
        .form-group input, .form-group textarea { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px; }
        .form-group textarea { resize: vertical; min-height: 80px; }
        .btn { padding: 10px 20px; border: none; border-radius: 8px; cursor: pointer; font-size: 14px; transition: all 0.2s; }
        .btn-primary { background: #007bff; color: #fff; }
        .btn-primary:hover { background: #0056b3; }
        .btn-danger { background: #dc3545; color: #fff; }
        .btn-danger:hover { background: #c82333; }
        .btn-secondary { background: #6c757d; color: #fff; }
        .btn-secondary:hover { background: #545b62; }
        .btn-group { display: flex; gap: 10px; flex-wrap: wrap; }
        .image-preview { max-width: 200px; max-height: 150px; margin-top: 10px; border-radius: 8px; display: none; }
        .news-list { display: flex; flex-direction: column; gap: 15px; }
        .news-item { background: #fff; border-radius: 12px; padding: 15px; display: flex; gap: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .news-image { width: 90px; height: 90px; object-fit: cover; border-radius: 8px; flex-shrink: 0; }
        .news-content { flex: 1; }
        .news-title { font-weight: 600; color: #333; margin-bottom: 8px; display: block; }
        .news-title:hover { color: #007bff; }
        .activity-description { color: #666; font-size: 14px; margin-bottom: 10px; }
        .item-tools { margin-top: 10px; }
        .empty { text-align: center; padding: 40px; color: #999; }
        .status { padding: 10px; border-radius: 8px; margin-bottom: 15px; text-align: center; }
        .status.success { background: #d4edda; color: #155724; }
        .status.error { background: #f8d7da; color: #721c24; }
        .status.loading { background: #fff3cd; color: #856404; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üì∞ Mis Noticias</h1>
        
        <div id="firebaseStatus" class="status loading">Conectando con Firebase...</div>
        
        <div class="form-section">
            <div class="form-group">
                <label>T√≠tulo *</label>
                <input type="text" id="title" placeholder="T√≠tulo de la noticia">
            </div>
            <div class="form-group">
                <label>Descripci√≥n</label>
                <textarea id="description" placeholder="Descripci√≥n de la noticia"></textarea>
            </div>
            <div class="form-group">
                <label>Subir imagen</label>
                <input type="file" id="imageFile" accept="image/*">
                <img id="imagePreview" class="image-preview" alt="Preview">
                <button id="removeImage" class="btn btn-secondary" style="margin-top:10px; display:none;">Quitar imagen</button>
            </div>
            <div class="btn-group">
                <button id="addBtn" class="btn btn-primary">‚ûï Agregar Noticia</button>
                <button id="clearAll" class="btn btn-danger">üóëÔ∏è Borrar Todo</button>
                <button id="syncBtn" class="btn btn-secondary">üîÑ Sincronizar</button>
            </div>
        </div>
        
        <div id="customNewsList" class="news-list">
            <div class="empty">Cargando...</div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-app.js";
        import { initializeFirestore, getFirestore, collection, addDoc, serverTimestamp, deleteDoc, doc, query, orderBy, limit, getDocs, updateDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL, deleteObject } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-storage.js";

        const PFX = '[MisNoticias]';
        const KEY = 'custom_news_items';
        
        // ‚úÖ Configuraci√≥n de Firebase INTEGRADA
        const firebaseConfig = {
            apiKey: "AIzaSyBGOBLIVvJxHqBhBae-hI1vM_KrzDEdtM0",
            authDomain: "iasa-app-bfe8b.firebaseapp.com",
            projectId: "iasa-app-bfe8b",
            storageBucket: "iasa-app-bfe8b.firebasestorage.app",
            messagingSenderId: "920148045932",
            appId: "1:920148045932:web:39e83aae9da23104eb2849",
            measurementId: "G-E13QW4LCE2"
        };

        let app, db, storage;
        let items = [];
        let uploadedImageData = '';
        let fbEnabled = false;

        // Inicializar Firebase
        try {
            app = initializeApp(firebaseConfig);
            try {
                db = initializeFirestore(app, { databaseId: 'news' });
                console.log(PFX, '‚úÖ Firestore inicializado con databaseId', 'news');
            } catch (e) {
                console.warn(PFX, '‚ö†Ô∏è initializeFirestore fall√≥, usando default', e);
                db = getFirestore(app);
            }
            storage = getStorage(app);
            fbEnabled = true;
            console.log(PFX, '‚úÖ Firebase inicializado correctamente');
            updateStatus('success', '‚úÖ Conectado a Firebase');
        } catch (e) {
            console.error(PFX, '‚ùå Error inicializando Firebase:', e);
            updateStatus('error', '‚ùå Error conectando a Firebase: ' + e.message);
        }

        function updateStatus(type, message) {
            const el = document.getElementById('firebaseStatus');
            el.className = 'status ' + type;
            el.textContent = message;
            if (type === 'success') {
                setTimeout(() => el.style.display = 'none', 3000);
            }
        }

        // Funciones de Firebase
        async function fbAddNews(data) {
            const safe = {
                title: String(data.title || ''),
                description: String(data.description || ''),
                image: String(data.image || ''),
                url: String(data.url || ''),
                storagePath: String(data.storagePath || '')
            };
            console.log(PFX, 'Guardando en Firebase...', safe.title);
            const res = await addDoc(collection(db, 'news'), { image: safe.image, storagePath: safe.storagePath, createdAt: serverTimestamp() });
            await updateDoc(doc(db, 'news', res.id), { title: safe.title, description: safe.description, url: safe.url });
            const verify = await getDoc(doc(db, 'news', res.id));
            const d = verify.exists() ? verify.data() : {};
            console.log(PFX, 'Verificaci√≥n:', { hasTitle: !!d.title, hasDescription: !!d.description, hasUrl: !!d.url });
            console.log(PFX, '‚úÖ Guardado con ID:', res.id);
            return res.id;
        }

        async function fbDeleteNews(id) {
            console.log(PFX, 'Eliminando de Firebase:', id);
            await deleteDoc(doc(db, 'news', id));
            console.log(PFX, '‚úÖ Eliminado');
        }

        async function fbListNews() {
            console.log(PFX, 'Cargando noticias de Firebase...');
            const q = query(collection(db, 'news'), orderBy('createdAt', 'desc'), limit(20));
            const snap = await getDocs(q);
            const list = snap.docs.map(d => ({ ...d.data(), id: d.id }));
            console.log(PFX, '‚úÖ Cargadas:', list.length, 'noticias');
            return list;
        }

        async function fbUploadImage(blob) {
            const path = 'news-images/' + Date.now() + '.jpg';
            console.log(PFX, 'Subiendo imagen...', path);
            const r = ref(storage, path);
            await uploadBytes(r, blob, { contentType: 'image/jpeg' });
            const url = await getDownloadURL(r);
            console.log(PFX, '‚úÖ Imagen subida:', url);
            return { url, path };
        }

        async function fbDeleteImage(path) {
            console.log(PFX, 'Eliminando imagen:', path);
            const r = ref(storage, path);
            await deleteObject(r);
        }

        // Funciones locales
        function escapeHtml(str) { 
            return String(str || '').replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;'); 
        }

        function loadLocal() { 
            try { 
                const v = localStorage.getItem(KEY); 
                items = Array.isArray(JSON.parse(v)) ? JSON.parse(v) : []; 
            } catch(e) { 
                items = []; 
            } 
        }

        function saveLocal() { 
            try { 
                localStorage.setItem(KEY, JSON.stringify(items)); 
            } catch(e) {} 
        }

        function buildItemHTML(item, idx) {
            const title = item.title || 'Sin t√≠tulo';
            const summary = item.description || '';
            const image = item.image || '';
            const url = item.url || '#';
            const img = image || 'data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" width="90" height="90"%3E%3Crect fill="%23eaeaea" width="90" height="90"/%3E%3C/svg%3E';
            const linkStart = url && url !== '#' ? `<a href="${url}" class="news-title" target="_blank" rel="noopener noreferrer">` : `<span class="news-title">`;
            const linkEnd = url && url !== '#' ? '</a>' : '</span>';
            return `
                <div class="news-item" data-idx="${idx}">
                    <img loading="lazy" onerror="this.style.display='none'" src="${img}" alt="" class="news-image">
                    <div class="news-content">
                        ${linkStart}${escapeHtml(title)}${linkEnd}
                        <div class="activity-description">${escapeHtml(summary)}</div>
                        <div class="item-tools">
                            <button class="btn btn-danger" data-remove="${idx}">Eliminar</button>
                        </div>
                    </div>
                </div>
            `;
        }

        function render() {
            const list = document.getElementById('customNewsList');
            if (!items.length) { 
                list.innerHTML = '<div class="empty">No hay noticias cargadas.</div>'; 
                return; 
            }
            list.innerHTML = items.map((it, idx) => buildItemHTML(it, idx)).join('');
        }

        async function add() {
            const title = document.getElementById('title').value.trim();
            const description = document.getElementById('description').value.trim();
            
            if (!title) {
                alert('El t√≠tulo es obligatorio');
                return;
            }

            console.log(PFX, 'Agregando noticia:', title);
            
            let finalImage = uploadedImageData;
            let remoteId = '';
            let storagePath = '';

            try {
                if (fbEnabled && uploadedImageData) {
                    const b = await dataURLToBlob(uploadedImageData);
                    const up = await fbUploadImage(b);
                    finalImage = up.url;
                    storagePath = up.path;
                }

                if (fbEnabled) {
                    remoteId = await fbAddNews({ title, description, image: finalImage || '', url: '', storagePath });
                }

                items.unshift({ 
                    id: remoteId, 
                    storagePath, 
                    title, 
                    description, 
                    image: finalImage, 
                    url: '', 
                    pubDate: new Date().toISOString() 
                });
                
                saveLocal();
                render();

                // Limpiar formulario
                document.getElementById('title').value = '';
                document.getElementById('description').value = '';
                
                uploadedImageData = '';
                document.getElementById('imageFile').value = '';
                document.getElementById('imagePreview').style.display = 'none';
                document.getElementById('removeImage').style.display = 'none';

                console.log(PFX, '‚úÖ Noticia agregada correctamente');

            } catch (err) {
                console.error(PFX, '‚ùå Error al agregar:', err);
                alert('Error al guardar: ' + err.message);
            }
        }

        async function clearAll() {
            if (!confirm('¬øEst√°s seguro de borrar todas las noticias?')) return;
            
            const copy = items.slice();
            items = [];
            saveLocal();
            render();

            if (fbEnabled) {
                for (const it of copy) {
                    try { if (it.id) await fbDeleteNews(it.id); } catch(e) {}
                    try { if (it.storagePath) await fbDeleteImage(it.storagePath); } catch(e) {}
                }
            }
            console.log(PFX, '‚úÖ Todo borrado');
        }

        async function syncFromFirebase() {
            if (!fbEnabled) {
                alert('Firebase no est√° conectado');
                return;
            }
            try {
                updateStatus('loading', 'üîÑ Sincronizando...');
                items = await fbListNews();
                saveLocal();
                render();
                updateStatus('success', '‚úÖ Sincronizado');
            } catch (err) {
                console.error(PFX, '‚ùå Error sincronizando:', err);
                updateStatus('error', '‚ùå Error: ' + err.message);
            }
        }

        async function removeItem(idx) {
            const it = items[idx];
            items.splice(idx, 1);
            saveLocal();
            render();

            if (fbEnabled && it) {
                try { if (it.id) await fbDeleteNews(it.id); } catch(e) {}
                try { if (it.storagePath) await fbDeleteImage(it.storagePath); } catch(e) {}
            }
            console.log(PFX, '‚úÖ Noticia eliminada');

            try {
                localStorage.removeItem('news_cache_data');
                localStorage.removeItem('news_cache_latest_ts');
                console.log(PFX, '‚úÖ Cache de noticias de la home page limpiado');
            } catch(e) {
                console.warn(PFX, '‚ö†Ô∏è No se pudo limpiar el cache de la home page', e);
            }
        }

        // Utilidades de imagen
        async function dataURLToBlob(dataUrl) { 
            const parts = dataUrl.split(','); 
            const mime = parts[0].match(/:(.*?);/)[1]; 
            const bstr = atob(parts[1]); 
            let n = bstr.length; 
            const u8arr = new Uint8Array(n); 
            while(n--) u8arr[n] = bstr.charCodeAt(n); 
            return new Blob([u8arr], {type: mime}); 
        }

        async function compressDataUrl(dataUrl, maxW, quality) {
            return new Promise((resolve) => {
                const img = new Image();
                img.onload = () => {
                    let w = img.width, h = img.height;
                    if (w > maxW) { const r = maxW / w; w = Math.round(w * r); h = Math.round(h * r); }
                    const canvas = document.createElement('canvas');
                    canvas.width = w; canvas.height = h;
                    canvas.getContext('2d').drawImage(img, 0, 0, w, h);
                    resolve(canvas.toDataURL('image/jpeg', quality));
                };
                img.src = dataUrl;
            });
        }

        // Event listeners
        document.getElementById('addBtn').addEventListener('click', add);
        document.getElementById('clearAll').addEventListener('click', clearAll);
        document.getElementById('syncBtn').addEventListener('click', syncFromFirebase);

        document.getElementById('customNewsList').addEventListener('click', (e) => {
            const btn = e.target.closest('[data-remove]');
            if (!btn) return;
            const idx = parseInt(btn.getAttribute('data-remove'), 10);
            if (!isNaN(idx)) removeItem(idx);
        });

        document.getElementById('imageFile').addEventListener('change', async (e) => {
            const f = e.target.files && e.target.files[0];
            if (!f) return;
            const raw = await new Promise((res, rej) => { 
                const fr = new FileReader(); 
                fr.onload = () => res(fr.result); 
                fr.onerror = rej; 
                fr.readAsDataURL(f); 
            });
            uploadedImageData = await compressDataUrl(raw, 900, 0.82);
            const pv = document.getElementById('imagePreview');
            pv.src = uploadedImageData;
            pv.style.display = 'block';
            document.getElementById('removeImage').style.display = 'inline-block';
        });

        document.getElementById('removeImage').addEventListener('click', () => {
            uploadedImageData = '';
            document.getElementById('imageFile').value = '';
            document.getElementById('imagePreview').style.display = 'none';
            document.getElementById('removeImage').style.display = 'none';
        });

        // Inicializar
        loadLocal();
        if (fbEnabled && items.length === 0) {
            syncFromFirebase();
        } else {
            render();
        }
    </script>
</body>
</html>